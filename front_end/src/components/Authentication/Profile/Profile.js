import React, { useEffect } from 'react';
import {useAuth0} from '@auth0/auth0-react';

const Profile = () =>{
    const {user, isAuthenticated, getAccessTokenSilently, } = useAuth0();
    var accessToken = "";

    useEffect(() => {
        const getUserTokendata = async () => {
          const domain = "dev-l7o00ivv.eu.auth0.com";
      
          try {
            accessToken = await getAccessTokenSilently({
              audience: `https://${domain}/api/v2/`,
              scope: "read:current_user",
            });
            localStorage.setItem('accessToken', accessToken)
          } catch (e) {
            console.log(e.message);
          }
        };
        getUserTokendata();
      }, []);

      const checkUserExists = async (id) => {    
        try {
          id = id.substring(id.indexOf("|") + 1);
          fetch('http://localhost:5000/api/checkUserExists/?id='+id)
            .then(res => res.json())
            .then(result => getUserMetadata(result.response, id));
          } catch (e) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
          console.log(e.message);
        }
      };
      const getUserMetadata = async (userType, id) => {    
        try {
          if(userType.length!=0){
            console.log("HERE", userType[0]);
            if(userType[0].userType==1){ // If it is an elderly user
              console.log("I am an elderly user");
              fetch('http://localhost:5000/api/getElderlyPortal/?id='+id)
              .then(res => res.json())
              .then(result => console.log('Result = ', result.response));  //Route to elderly screen
            }
            else if (userType[0].userType==2){// If it is a Curator
              console.log("I am a curator");
            }
            else if (userType[0].userType==3){// If it is a Close circle member
              console.log("I am a close circle member");
              fetch('http://localhost:5000/api/getCloseCircle/?id='+id)
              .then(res => res.json())
              .then(result => console.log('Result = ', result.response));  //Route to close circle screen
            }
          }
          else{
            //No user account in our database
            //Redirect to Create account screen?
          }
          } catch (e) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
          console.log(e.message);
        }
      };
    return(
        isAuthenticated && (
        <div>
            <img src={user.picture} alt={user.name}></img>
            <h2>{user.name}</h2>
            <p>{user.email}</p>
            {JSON.stringify(user, null, 2)}
            <button onClick={() => checkUserExists(user.sub)}>Check User Exists</button>

        </div>
        )
    )
}

export default Profile;

//#endregion
